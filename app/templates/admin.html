{% extends "base.html" %}
{% block content %}

<div class="container mt-4 p-4 rounded bg-dark text-white">
  <h1 class="text-center mb-4">Admin Dashboard - Round {{ round }}</h1>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="user-tips-tab" data-bs-toggle="tab" data-bs-target="#user-tips" type="button" role="tab" aria-controls="user-tips" aria-selected="true">
        User Tips
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="false">
        Register User
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="change-username-tab" data-bs-toggle="tab" data-bs-target="#change-username" type="button" role="tab" aria-controls="change-username" aria-selected="false">
        Change Username
      </button>
    </li>
  </ul>

  <!-- Tabs Content -->
  <div class="tab-content" id="adminTabContent">
    <!-- User Tips Tab -->
    <div class="tab-pane fade show active" id="user-tips" role="tabpanel" aria-labelledby="user-tips-tab">
      <table class="table table-bordered table-striped table-dark">
        <thead class="table-light">
          <tr>
            <th>User</th>
            <th>Has Tipped?</th>
            <th>Tips Submitted</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.username }}</td>
            <td>
              {% if tips_by_user[user.id]|length > 0 %}
                ✅
              {% else %}
                ❌
              {% endif %}
            </td>
            <td>
              {% for tip in tips_by_user[user.id] %}
                Match ID {{ tip.match }} → {{ tip.selected_team }}<br>
              {% endfor %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Register User Tab -->
    <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
      <p class="mt-3">Register User functionality coming soon.</p>
    </div>

    <!-- Change Username Tab -->
    <div class="tab-pane fade" id="change-username" role="tabpanel" aria-labelledby="change-username-tab">
      <h5 class="mt-4">Change a User's Username</h5>

      <form method="POST" action="{{ url_for('admin.admin_dashboard') }}" class="row g-3 mt-3">
        <div class="col-md-4">
          <label for="user_id" class="form-label">Select User</label>
          <select class="form-select" id="user_id" name="user_id" required>
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label for="new_username" class="form-label">New Username</label>
          <input type="text" class="form-control" id="new_username" name="new_username" required>
        </div>

        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-warning w-100">Update Username</button>
        </div>
      </form>

      {% if username_update_success %}
        <div class="alert alert-success mt-3">Username updated successfully.</div>
      {% elif username_update_error %}
        <div class="alert alert-danger mt-3">{{ username_update_error }}</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Bootstrap Bundle with Popper (required for tabs and interactive components) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-q2my4o5I5w6ZD+1RM6JZ4gMZb97E8X0GulD6hBS4vtd4K6FnNsZtI0jP0VZB4sQD" crossorigin="anonymous"></script>

<!-- Activate tab functionality on click -->
<script>
  const triggerTabList = document.querySelectorAll('#adminTab button')
  triggerTabList.forEach(triggerEl => {
    const tabTrigger = new bootstrap.Tab(triggerEl)

    triggerEl.addEventListener('click', event => {
      event.preventDefault()
      tabTrigger.show()
    })
  })
</script>

{% endblock %}

